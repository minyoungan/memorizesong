<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyric Memorizer - SRS Quiz</title>
    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary: #4285f4;
            --success: #34a853;
            --danger: #ea4335;
            --bg: #ffffff;
            --text: #202124;
            --gray: #dfe1e5;
            --light-gray: #f1f3f4;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Header & Search */
        .header {
            width: 100%;
            max-width: 700px;
            padding: 20px;
            text-align: center;
            margin-top: 25vh; /* Starts in center */
            transition: margin-top 0.4s ease;
        }
        .header.compact { margin-top: 2vh; }

        h1 { font-weight: 300; margin-bottom: 20px; color: #333; }

        .search-box { position: relative; width: 100%; }

        input[type="text"] {
            width: 100%;
            padding: 14px 45px 14px 24px; /* Extra padding on right for X button */
            font-size: 16px;
            border: 1px solid var(--gray);
            border-radius: 24px;
            outline: none;
            box-shadow: 0 1px 6px rgba(32,33,36,0.28);
            box-sizing: border-box;
            background-color: #fff;
            transition: background-color 0.3s;
        }
        
        /* Grey out state */
        input[type="text"]:disabled {
            background-color: #f1f3f4;
            color: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        input[type="text"]:focus:not(:disabled) { box-shadow: 0 1px 6px rgba(32,33,36,0.5); }

        /* The X Button */
        .clear-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #777;
            cursor: pointer;
            padding: 5px 10px;
            display: none; /* Hidden by default */
            z-index: 5;
        }
        .clear-btn:hover { color: #333; }

        .suggestions {
            position: absolute;
            top: 50px; left: 0; right: 0;
            background: white;
            border: 1px solid var(--gray);
            border-top: none;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 4px 6px rgba(32,33,36,0.28);
            list-style: none;
            padding: 0; margin: 0;
            z-index: 100;
            display: none;
            text-align: left;
        }
        .suggestions li { padding: 12px 24px; cursor: pointer; border-bottom: 1px solid #f1f1f1; }
        .suggestions li:hover { background: #f8f9fa; }

        /* Navigation Tabs */
        .nav-tabs {
            display: none; 
            margin-top: 20px;
            justify-content: center;
            gap: 10px;
        }
        .tab-btn {
            padding: 10px 24px;
            border: none;
            background: var(--light-gray);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Views */
        .content-area {
            width: 100%;
            max-width: 700px;
            padding: 20px;
            margin-bottom: 50px;
            display: none; /* Hidden until search */
        }
        .content-area.active { display: block; }
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* Study Mode */
        .lyric-row {
            padding: 12px 0;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }
        .lyric-text-group { flex: 1; text-align: left; }
        .orig-line { font-size: 1.1rem; font-weight: 500; margin-bottom: 4px; color: #000; }
        .trans-line { font-size: 0.9rem; color: var(--primary); }
        .mastery-indicator { font-size: 0.8rem; color: #888; margin-left: 10px; min-width: 70px; text-align: right; }

        /* Quiz Mode */
        .quiz-card {
            background: white;
            border: 1px solid var(--gray);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .quiz-prompt { font-size: 1.4rem; margin-bottom: 30px; line-height: 1.6; }
        .quiz-input {
            font-size: 1.2rem;
            padding: 10px;
            border: 2px solid var(--gray);
            border-radius: 8px;
            width: 60%;
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }
        .quiz-input:focus { border-color: var(--primary); outline: none; }
        
        .btn-check {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 24px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
        }

        .feedback-msg { height: 20px; margin-top: 15px; font-weight: bold; }
        .feedback-msg.correct { color: var(--success); }
        .feedback-msg.wrong { color: var(--danger); }

        .stats-bar {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #666;
            display: flex;
            justify-content: space-around;
        }

        .loading-spinner { color: #888; font-style: italic; margin-top: 20px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="header" id="header">
        <h1>Lyric Memorizer</h1>
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Search for a song..." autocomplete="off">
            <span id="clear-btn" class="clear-btn" title="Clear Search">&times;</span>
            <ul class="suggestions" id="suggestions"></ul>
        </div>

        <div class="nav-tabs" id="nav-tabs">
            <button class="tab-btn active" onclick="switchMode('study')">ðŸ“– Study</button>
            <button class="tab-btn" onclick="switchMode('quiz')">ðŸ§  Quiz</button>
        </div>
    </div>

    <div class="content-area" id="main-content">
        
        <div id="study-view" class="view-section active">
            <div id="loading-msg" class="loading-spinner hidden">Loading lyrics and removing tracking scripts...</div>
            <div id="lyrics-list"></div>
        </div>

        <div id="quiz-view" class="view-section">
            <div class="quiz-card">
                <div id="quiz-question-container">
                    <div class="quiz-prompt" id="quiz-prompt">Press Start to review!</div>
                    <input type="text" id="quiz-answer" class="quiz-input" placeholder="Type missing word" autocomplete="off">
                    <br>
                    <button id="btn-action" class="btn-check">Start Quiz</button>
                    <div class="feedback-msg" id="feedback"></div>
                </div>
            </div>
            <div class="stats-bar">
                <span id="stat-due">Due: 0</span>
                <span id="stat-learned">Learned: 0</span>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG ---
        const RAPID_API_KEY = '39ef605fcfmshfb8f3f73fff37e2p1a9076jsn4d35c9c6d6d5';
        const RAPID_API_HOST = 'genius-song-lyrics1.p.rapidapi.com';

        // --- 2. STATE ---
        let lyricsData = []; 
        let quizState = { active: false, currentId: null };

        // --- 3. DOM ELEMENTS ---
        const els = {
            header: document.getElementById('header'),
            input: document.getElementById('search-input'),
            clearBtn: document.getElementById('clear-btn'),
            suggestions: document.getElementById('suggestions'),
            tabs: document.getElementById('nav-tabs'),
            mainContent: document.getElementById('main-content'),
            studyView: document.getElementById('study-view'),
            quizView: document.getElementById('quiz-view'),
            lyricsList: document.getElementById('lyrics-list'),
            loadingMsg: document.getElementById('loading-msg'),
            quizPrompt: document.getElementById('quiz-prompt'),
            quizInput: document.getElementById('quiz-answer'),
            btnAction: document.getElementById('btn-action'),
            feedback: document.getElementById('feedback'),
            statDue: document.getElementById('stat-due'),
            statLearned: document.getElementById('stat-learned')
        };

        // --- 4. SEARCH ---
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        els.input.addEventListener('input', debounce((e) => {
            const val = e.target.value.trim();
            if(val.length > 2) fetchSuggestions(val);
            else els.suggestions.style.display = 'none';
        }, 400));

        async function fetchSuggestions(query) {
            try {
                const url = `https://${RAPID_API_HOST}/search/?q=${encodeURIComponent(query)}&per_page=5`;
                const res = await fetch(url, { headers: { 'x-rapidapi-key': RAPID_API_KEY, 'x-rapidapi-host': RAPID_API_HOST } });
                const data = await res.json();
                renderSuggestions(data.hits || []);
            } catch(e) { console.error(e); }
        }

        function renderSuggestions(hits) {
            els.suggestions.innerHTML = '';
            if(!hits.length) { els.suggestions.style.display = 'none'; return; }
            hits.forEach(h => {
                const li = document.createElement('li');
                li.innerHTML = `<b>${h.result.title}</b> <span style="font-size:0.8em;color:#666">by ${h.result.artist_names}</span>`;
                li.onclick = () => loadSong(h.result.id, h.result.full_title);
                els.suggestions.appendChild(li);
            });
            els.suggestions.style.display = 'block';
        }

        // --- 5. CLEAR / RESET FUNCTION ---
        els.clearBtn.addEventListener('click', resetApp);

        function resetApp() {
            // 1. Reset Input
            els.input.value = '';
            els.input.disabled = false;
            els.clearBtn.style.display = 'none';
            
            // 2. Hide Content
            els.header.classList.remove('compact');
            els.tabs.style.display = 'none';
            els.mainContent.classList.remove('active');
            els.suggestions.style.display = 'none';
            
            // 3. Clear Data
            lyricsData = [];
            els.lyricsList.innerHTML = '';
        }

        // --- 6. LOAD SONG ---
        async function loadSong(id, title) {
            // UI LOCK
            els.suggestions.style.display = 'none';
            els.input.value = title;
            els.input.disabled = true; // GREY OUT
            els.clearBtn.style.display = 'block'; // SHOW X
            
            // Transition
            els.header.classList.add('compact');
            els.tabs.style.display = 'flex';
            els.mainContent.classList.add('active');
            els.loadingMsg.classList.remove('hidden');
            els.lyricsList.innerHTML = '';
            switchMode('study');

            try {
                const url = `https://${RAPID_API_HOST}/song/lyrics/?id=${id}`;
                const res = await fetch(url, { headers: { 'x-rapidapi-key': RAPID_API_KEY, 'x-rapidapi-host': RAPID_API_HOST } });
                const data = await res.json();

                let rawHtml = "";
                if (data.lyrics && data.lyrics.lyrics && data.lyrics.lyrics.body && data.lyrics.lyrics.body.html) {
                    rawHtml = data.lyrics.lyrics.body.html;
                } else if (data.lyrics) rawHtml = data.lyrics;

                const cleanHtml = sanitizeHTML(rawHtml);
                processLyrics(cleanHtml);

            } catch (e) {
                els.loadingMsg.innerText = "Error loading lyrics. Please try another song.";
            }
        }

        function sanitizeHTML(htmlString) {
            let clean = htmlString.replace(/<script\b[^>]*>[\s\S]*?<\/script>/gim, "");
            clean = clean.replace(/<iframe\b[^>]*>[\s\S]*?<\/iframe>/gim, "");
            clean = clean.replace(/<style\b[^>]*>[\s\S]*?<\/style>/gim, "");
            clean = clean.replace(/<img\b[^>]*>/gim, "");
            return clean;
        }

        function processLyrics(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const textContent = tempDiv.innerText;

            lyricsData = textContent.split('\n')
                .filter(line => line.trim() !== '' && !line.startsWith('['))
                .map((line, idx) => ({
                    id: idx,
                    original: line.trim(),
                    translation: '...',
                    nextReview: Date.now(),
                    level: 0
                }));

            renderStudyList();
            els.loadingMsg.classList.add('hidden');
            startTranslations();
        }

        // --- 7. TRANSLATIONS ---
        async function startTranslations() {
            for(let i=0; i<lyricsData.length; i++) {
                if(i > 20) break;
                await new Promise(r => setTimeout(r, 300));
                try {
                    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(lyricsData[i].original)}&langpair=en|ko`);
                    const data = await res.json();
                    if(data.responseData) {
                        lyricsData[i].translation = data.responseData.translatedText;
                        updateRowUI(i);
                    }
                } catch(e) {}
            }
        }

        function renderStudyList() {
            els.lyricsList.innerHTML = '';
            lyricsData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'lyric-row';
                div.id = `row-${item.id}`;
                div.innerHTML = getRowHTML(item);
                els.lyricsList.appendChild(div);
            });
        }

        function updateRowUI(idx) {
            const row = document.getElementById(`row-${idx}`);
            if(row) row.innerHTML = getRowHTML(lyricsData[idx]);
        }

        function getRowHTML(item) {
            let lvl = "New";
            if(item.level > 0) lvl = "Learned";
            if(item.level > 3) lvl = "Mastered";
            return `
                <div class="lyric-text-group">
                    <div class="orig-line">${item.original}</div>
                    <div class="trans-line">${item.translation}</div>
                </div>
                <div class="mastery-indicator">${lvl}</div>
            `;
        }

        function switchMode(mode) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            
            if(mode === 'study') {
                els.studyView.classList.add('active');
                document.querySelector('button[onclick="switchMode(\'study\')"]').classList.add('active');
                renderStudyList(); 
            } else {
                els.quizView.classList.add('active');
                document.querySelector('button[onclick="switchMode(\'quiz\')"]').classList.add('active');
                resetQuizUI();
                updateStats();
            }
        }

        // --- 8. QUIZ ENGINE ---
        function resetQuizUI() {
            els.quizPrompt.innerText = "Press Start to begin reviewing.";
            els.quizInput.style.display = 'none';
            els.btnAction.style.display = 'inline-block';
            els.btnAction.innerText = "Start Quiz";
            els.feedback.innerText = "";
            quizState.active = false;
        }

        function getNextCard() {
            const now = Date.now();
            const due = lyricsData.filter(l => l.nextReview <= now);
            if(!due.length) return null;
            due.sort((a,b) => a.level - b.level);
            return due[0];
        }

        function createCloze(text) {
            const words = text.split(' ');
            const validIndices = words.map((w, i) => w.replace(/[^a-zA-Z]/g,'').length > 3 ? i : -1).filter(i => i !== -1);
            let targetIndex;
            if(validIndices.length === 0) targetIndex = words.length - 1;
            else targetIndex = validIndices[Math.floor(Math.random() * validIndices.length)];

            const answer = words[targetIndex].replace(/[^a-zA-Z0-9]/g, '');
            const displayWords = [...words];
            displayWords[targetIndex] = "______";

            return { question: displayWords.join(' '), answer: answer };
        }

        els.btnAction.addEventListener('click', () => {
            if(!quizState.active) {
                const card = getNextCard();
                if(!card) {
                    els.quizPrompt.innerText = "ðŸŽ‰ All caught up! Great job.";
                    els.quizInput.style.display = 'none';
                    els.btnAction.style.display = 'none';
                    return;
                }

                quizState.currentId = card.id;
                const cloze = createCloze(card.original);
                card.currentAnswer = cloze.answer;

                els.quizPrompt.innerHTML = `${cloze.question}<br><br><span style="color:#888;font-size:0.8em">${card.translation}</span>`;
                els.quizInput.style.display = 'inline-block';
                els.quizInput.value = '';
                els.quizInput.focus();
                els.feedback.innerText = '';
                els.btnAction.innerText = "Check";
                quizState.active = true;
            } else {
                const card = lyricsData[quizState.currentId];
                const userAns = els.quizInput.value.trim().toLowerCase();
                const correctAns = card.currentAnswer.toLowerCase();

                if(userAns === correctAns) {
                    els.feedback.innerText = "Correct! +1 Level";
                    els.feedback.className = "feedback-msg correct";
                    card.level++;
                    card.nextReview = Date.now() + (card.level * 60 * 1000); 
                } else {
                    els.feedback.innerText = `Wrong! Answer: ${card.currentAnswer}`;
                    els.feedback.className = "feedback-msg wrong";
                    card.level = 0;
                    card.nextReview = Date.now() + 5000;
                }

                els.btnAction.innerText = "Next >>";
                quizState.active = false;
                updateStats();
            }
        });

        els.quizInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') els.btnAction.click();
        });

        function updateStats() {
            const now = Date.now();
            els.statDue.innerText = `Due: ${lyricsData.filter(l => l.nextReview <= now).length}`;
            els.statLearned.innerText = `Learned: ${lyricsData.filter(l => l.level > 0).length}`;
        }
        
        document.addEventListener('click', (e) => {
            if (!els.input.contains(e.target) && !els.suggestions.contains(e.target)) {
                els.suggestions.style.display = 'none';
            }
        });
    </script>
</body>
</html>
